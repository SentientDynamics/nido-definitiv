{
	"name": "df_B1_Payslips_ApiToDefinitiv",
	"properties": {
		"folder": {
			"name": "01_Payslips"
		},
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "ds_adsl2_stnidoprodeastau100_json_2",
						"type": "DatasetReference"
					},
					"name": "SourceBlobDefinitivPayslips"
				},
				{
					"dataset": {
						"referenceName": "ds_sql_tnk001",
						"type": "DatasetReference"
					},
					"name": "SourceSqlDefinitivPayslips"
				}
			],
			"sinks": [
				{
					"dataset": {
						"referenceName": "ds_sql_tnk001",
						"type": "DatasetReference"
					},
					"name": "SinkSqlDefinitivPayslips",
					"rejectedDataLinkedService": {
						"referenceName": "ls_adls2_stnidoprodeastau100",
						"type": "LinkedServiceReference"
					}
				},
				{
					"dataset": {
						"referenceName": "ds_adls2_stnidoprodeastau100_csv",
						"type": "DatasetReference"
					},
					"name": "sink1"
				}
			],
			"transformations": [
				{
					"name": "AlterRow1"
				},
				{
					"name": "CastDateType1"
				},
				{
					"name": "FilterPeriodEndDate"
				},
				{
					"name": "Insert"
				},
				{
					"name": "NotExistsDelete"
				},
				{
					"name": "Delete"
				},
				{
					"name": "Update"
				},
				{
					"name": "UnionAlterRowCondition"
				},
				{
					"name": "SelectSqlDefinitivPayslips"
				},
				{
					"name": "SelectBlobDefinitivPayslips"
				},
				{
					"name": "ExistsUpdate"
				},
				{
					"name": "NotExistsInsert"
				},
				{
					"name": "Aggregate1"
				}
			],
			"script": "parameters{\n\tPipelineTriggerTime as string,\n\tPipelineRunId as string,\n\tPipelineName as string\n}\nsource(output(\n\t\t{OrgPayRun.OrganizationId} as string,\n\t\t{OrgPayRun.PayRunId} as string,\n\t\t{OrgPayRun.PeriodEndDate} as date,\n\t\t{OrgPayRun.PeriodStartDate} as date,\n\t\tPipelineRunId as string,\n\t\tPipelineTriggerTime as string,\n\t\tbaseRate as double,\n\t\tdepartmentCode as string,\n\t\temployeeId as string,\n\t\temploymentTypeCode as string,\n\t\temploymentTypeCodeDesc as string,\n\t\tfirstName as string,\n\t\t{hoursOrA/DCode} as integer,\n\t\t{hoursOrA/DCodeDesc} as string,\n\t\tidNumber as integer,\n\t\tlevel1Code as string,\n\t\tlevel2Code as string,\n\t\tlineItemId as integer,\n\t\tnumberOfUnits as double,\n\t\tpayDate as string,\n\t\tpayMethodCode as string,\n\t\tpayMethodCodeDesc as string,\n\t\tpayslipId as string,\n\t\tpayslipNumber as string,\n\t\tperiodEndingDate as string,\n\t\tperiodStartDate as string,\n\t\tpositionTitle as string,\n\t\tprojectCode as string,\n\t\trate as double,\n\t\tsurname as string,\n\t\tvalue as double\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinferDriftedColumnTypes: true,\n\tignoreNoFilesFound: false,\n\trowUrlColumn: 'SourceFileName',\n\tdocumentForm: 'documentPerLine') ~> SourceBlobDefinitivPayslips\nsource(output(\n\t\tRecordId as string,\n\t\tRecordVersion as binary,\n\t\tRecordCreatedDate as timestamp,\n\t\tRecordModifiedDate as timestamp,\n\t\tRecordIsDeleted as boolean,\n\t\tRecordIsDefinitiv as boolean,\n\t\tRecordIsPreceda as boolean,\n\t\tPipelineRunId as string,\n\t\tPipelineSourceFileName as string,\n\t\tPipelineTriggerTime as string,\n\t\tEmployeeId as string,\n\t\tOrganizationId as string,\n\t\tPayRunId as string,\n\t\tPayslipId as string,\n\t\tPayRunPeriodEndDate as date,\n\t\tPayRunPeriodStartDate as date,\n\t\tPayslipLineItemId as integer,\n\t\tPayslipNumber as string,\n\t\tBaseRate as double,\n\t\tDepartmentCode as string,\n\t\tEmploymentTypeCode as string,\n\t\tEmploymentTypeCodeDesc as string,\n\t\tFirstName as string,\n\t\tHoursOrADCode as integer,\n\t\tHoursOrADCodeDesc as string,\n\t\tIdNumber as integer,\n\t\tLevel1Code as string,\n\t\tLevel2Code as string,\n\t\tNumberOfUnits as double,\n\t\tPayDate as date,\n\t\tPayMethodCode as string,\n\t\tPayMethodCodeDesc as string,\n\t\tPeriodEndingDate as date,\n\t\tPeriodStartDate as date,\n\t\tPositionTitle as string,\n\t\tProjectCode as string,\n\t\tRate as double,\n\t\tSurname as string,\n\t\tValue as double\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinferDriftedColumnTypes: true,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tformat: 'table') ~> SourceSqlDefinitivPayslips\nUnionAlterRowCondition alterRow(insertIf(true()),\n\tinsertIf(AlterRowCondition==\"Insert\"),\n\tupdateIf(AlterRowCondition==\"Update\"),\n\tdeleteIf(AlterRowCondition==\"Delete\")) ~> AlterRow1\nSelectBlobDefinitivPayslips derive(PeriodEndingDate = toDate(PeriodEndingDate),\n\t\tPeriodStartDate = toDate(PeriodStartDate),\n\t\tPayDate = toDate(PayDate)) ~> CastDateType1\nCastDateType1 filter(greater(PeriodEndingDate, toDate(\"2021-10-15\", 'yyyy-MM-dd'))) ~> FilterPeriodEndDate\nNotExistsInsert derive(AlterRowCondition = \"Insert\",\n\t\tRecordCreatedDate = fromUTC(toTimestamp($PipelineTriggerTime, 'yyyy-MM-dd\\'T\\'HH:mm:ss'), 'A.U.S. Eastern Standard Time'),\n\t\tRecordIsDeleted = false(),\n\t\tPipelineTriggerTime = fromUTC(toTimestamp($PipelineTriggerTime, 'yyyy-MM-dd\\'T\\'HH:mm:ss'), 'A.U.S. Eastern Standard Time'),\n\t\tPipelienRunId = $PipelineRunId) ~> Insert\nSelectSqlDefinitivPayslips, FilterPeriodEndDate exists(SelectSqlDefinitivPayslips@DepartmentCode == SelectBlobDefinitivPayslips@DepartmentCode\n\t&& SelectSqlDefinitivPayslips@EmployeeId == SelectBlobDefinitivPayslips@EmployeeId\n\t&& SelectSqlDefinitivPayslips@HoursOrADCode == SelectBlobDefinitivPayslips@HoursOrADCode\n\t&& SelectSqlDefinitivPayslips@HoursOrADCodeDesc == SelectBlobDefinitivPayslips@HoursOrADCodeDesc\n\t&& SelectSqlDefinitivPayslips@Level1Code == SelectBlobDefinitivPayslips@Level1Code\n\t&& SelectSqlDefinitivPayslips@Level2Code == SelectBlobDefinitivPayslips@Level2Code\n\t&& SelectSqlDefinitivPayslips@PayslipId == SelectBlobDefinitivPayslips@PayslipId\n\t&& SelectSqlDefinitivPayslips@PayslipLineItemId == SelectBlobDefinitivPayslips@PayslipLineItemId\n\t&& SelectSqlDefinitivPayslips@PositionTitle == SelectBlobDefinitivPayslips@PositionTitle\n\t&& SelectSqlDefinitivPayslips@ProjectCode == SelectBlobDefinitivPayslips@ProjectCode\n\t&& SelectSqlDefinitivPayslips@Rate == SelectBlobDefinitivPayslips@Rate,\n\tnegate:true,\n\tbroadcast: 'right')~> NotExistsDelete\nNotExistsDelete derive(AlterRowCondition = \"Delete\",\n\t\tRecordModifiedDate = fromUTC(toTimestamp($PipelineTriggerTime, 'yyyy-MM-dd\\'T\\'HH:mm:ss'), 'A.U.S. Eastern Standard Time'),\n\t\tRecordIsDeleted = true(),\n\t\tPipelineTriggerTime = fromUTC(toTimestamp($PipelineTriggerTime, 'yyyy-MM-dd\\'T\\'HH:mm:ss'), 'A.U.S. Eastern Standard Time'),\n\t\tPipelineRunId = $PipelineRunId) ~> Delete\nExistsUpdate derive(AlterRowCondition = \"Update\",\n\t\tRecordModifiedDate = fromUTC(toTimestamp($PipelineTriggerTime, 'yyyy-MM-dd\\'T\\'HH:mm:ss'), 'A.U.S. Eastern Standard Time'),\n\t\tRecordIsDeleted = false(),\n\t\tPipelineTriggerTime = fromUTC(toTimestamp($PipelineTriggerTime, 'yyyy-MM-dd\\'T\\'HH:mm:ss'), 'A.U.S. Eastern Standard Time'),\n\t\tPipelineRunId = $PipelineRunId) ~> Update\nUpdate, Insert, Delete union(byName: true)~> UnionAlterRowCondition\nSourceSqlDefinitivPayslips select(mapColumn(\n\t\tEmployeeId,\n\t\tOrganizationId,\n\t\tPayRunId,\n\t\tPayslipId,\n\t\tPayslipLineItemId,\n\t\tDepartmentCode,\n\t\tHoursOrADCode,\n\t\tHoursOrADCodeDesc,\n\t\tLevel1Code,\n\t\tLevel2Code,\n\t\tPositionTitle,\n\t\tProjectCode,\n\t\tRate\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectSqlDefinitivPayslips\nSourceBlobDefinitivPayslips select(mapColumn(\n\t\tBaseRate = baseRate,\n\t\tDepartmentCode = departmentCode,\n\t\tEmployeeId = employeeId,\n\t\tEmploymentTypeCode = employmentTypeCode,\n\t\tEmploymentTypeCodeDesc = employmentTypeCodeDesc,\n\t\tFirstName = firstName,\n\t\tHoursOrADCode = {hoursOrA/DCode},\n\t\tHoursOrADCodeDesc = {hoursOrA/DCodeDesc},\n\t\tIdNumber = idNumber,\n\t\tLevel1Code = level1Code,\n\t\tLevel2Code = level2Code,\n\t\tPayslipLineItemId = lineItemId,\n\t\tNumberOfUnits = numberOfUnits,\n\t\tPayDate = payDate,\n\t\tPayMethodCode = payMethodCode,\n\t\tPayMethodCodeDesc = payMethodCodeDesc,\n\t\tOrganizationId = {OrgPayRun.OrganizationId},\n\t\tPayRunId = {OrgPayRun.PayRunId},\n\t\tPayRunPeriodEndDate = {OrgPayRun.PeriodEndDate},\n\t\tPayRunPeriodStartDate = {OrgPayRun.PeriodStartDate},\n\t\tPayslipId = payslipId,\n\t\tPayslipNumber = payslipNumber,\n\t\tPeriodEndingDate = periodEndingDate,\n\t\tPeriodStartDate = periodStartDate,\n\t\tPositionTitle = positionTitle,\n\t\tProjectCode = projectCode,\n\t\tRate = rate,\n\t\tSurname = surname,\n\t\tValue = value,\n\t\tPipelineSourceFileName = SourceFileName\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectBlobDefinitivPayslips\nFilterPeriodEndDate, SelectSqlDefinitivPayslips exists(SelectBlobDefinitivPayslips@DepartmentCode == SelectSqlDefinitivPayslips@DepartmentCode\n\t&& SelectBlobDefinitivPayslips@EmployeeId == SelectSqlDefinitivPayslips@EmployeeId\n\t&& SelectBlobDefinitivPayslips@HoursOrADCode == SelectSqlDefinitivPayslips@HoursOrADCode\n\t&& SelectBlobDefinitivPayslips@HoursOrADCodeDesc == SelectSqlDefinitivPayslips@HoursOrADCodeDesc\n\t&& SelectBlobDefinitivPayslips@Level1Code == SelectSqlDefinitivPayslips@Level1Code\n\t&& SelectBlobDefinitivPayslips@Level2Code == SelectSqlDefinitivPayslips@Level2Code\n\t&& SelectBlobDefinitivPayslips@OrganizationId == SelectSqlDefinitivPayslips@OrganizationId\n\t&& SelectBlobDefinitivPayslips@PayRunId == SelectSqlDefinitivPayslips@PayRunId\n\t&& SelectBlobDefinitivPayslips@PayslipId == SelectSqlDefinitivPayslips@PayslipId\n\t&& SelectBlobDefinitivPayslips@PayslipLineItemId == SelectSqlDefinitivPayslips@PayslipLineItemId\n\t&& SelectBlobDefinitivPayslips@PositionTitle == SelectSqlDefinitivPayslips@PositionTitle\n\t&& SelectBlobDefinitivPayslips@ProjectCode == SelectSqlDefinitivPayslips@ProjectCode\n\t&& SelectBlobDefinitivPayslips@Rate == SelectSqlDefinitivPayslips@Rate,\n\tnegate:false,\n\tbroadcast: 'auto')~> ExistsUpdate\nFilterPeriodEndDate, SelectSqlDefinitivPayslips exists(SelectBlobDefinitivPayslips@DepartmentCode == SelectSqlDefinitivPayslips@DepartmentCode\n\t&& SelectBlobDefinitivPayslips@EmployeeId == SelectSqlDefinitivPayslips@EmployeeId\n\t&& SelectBlobDefinitivPayslips@HoursOrADCode == SelectSqlDefinitivPayslips@HoursOrADCode\n\t&& SelectBlobDefinitivPayslips@HoursOrADCodeDesc == SelectSqlDefinitivPayslips@HoursOrADCodeDesc\n\t&& SelectBlobDefinitivPayslips@Level1Code == SelectSqlDefinitivPayslips@Level1Code\n\t&& SelectBlobDefinitivPayslips@Level2Code == SelectSqlDefinitivPayslips@Level2Code\n\t&& SelectBlobDefinitivPayslips@OrganizationId == SelectSqlDefinitivPayslips@OrganizationId\n\t&& SelectBlobDefinitivPayslips@PayRunId == SelectSqlDefinitivPayslips@PayRunId\n\t&& SelectBlobDefinitivPayslips@PayslipId == SelectSqlDefinitivPayslips@PayslipId\n\t&& SelectBlobDefinitivPayslips@PayslipLineItemId == SelectSqlDefinitivPayslips@PayslipLineItemId\n\t&& SelectBlobDefinitivPayslips@PositionTitle == SelectSqlDefinitivPayslips@PositionTitle\n\t&& SelectBlobDefinitivPayslips@ProjectCode == SelectSqlDefinitivPayslips@ProjectCode\n\t&& SelectBlobDefinitivPayslips@Rate == SelectSqlDefinitivPayslips@Rate,\n\tnegate:true,\n\tbroadcast: 'auto')~> NotExistsInsert\nUnionAlterRowCondition aggregate(groupBy(AlterRowCondition),\n\tCountAlterRowCondition = count(AlterRowCondition)) ~> Aggregate1\nAlterRow1 sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\ttruncate:true,\n\tformat: 'table',\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\terrorHandlingOption: 'allErrors',\n\toutputRejectedData: true,\n\trejectedData_fileSystem: 'container-adf-nido-prod-eastau-100-1',\n\trejectedData_folderPath: (concat(\"ds_adsl2_stnidoprodeastau100_json/\", $PipelineName, \"/\",\r\n    toString(toTimestamp(left($PipelineTriggerTime, 20), 'yyyy-MM-dd\\'T\\'HH:mm:ss'), 'yyyy-MM-dd\\'T\\'HH-mm-ss'),\r\n    \"_PipelineRunId_\", $PipelineRunId, \"_ErrorOutput\")),\n\ttransactionCommit: 'batch',\n\treportSuccessOnError: false,\n\tmapColumn(\n\t\tBaseRate,\n\t\tDepartmentCode,\n\t\tEmployeeId,\n\t\tEmploymentTypeCode,\n\t\tEmploymentTypeCodeDesc,\n\t\tFirstName,\n\t\tHoursOrADCode,\n\t\tHoursOrADCodeDesc,\n\t\tIdNumber,\n\t\tLevel1Code,\n\t\tLevel2Code,\n\t\tNumberOfUnits,\n\t\tPayDate,\n\t\tPayMethodCode,\n\t\tPayMethodCodeDesc,\n\t\tOrganizationId,\n\t\tPayRunId,\n\t\tPayRunPeriodEndDate,\n\t\tPayRunPeriodStartDate,\n\t\tPayslipId,\n\t\tPayslipNumber,\n\t\tPeriodEndingDate,\n\t\tPeriodStartDate,\n\t\tPipelineRunId,\n\t\tPipelineTriggerTime,\n\t\tPositionTitle,\n\t\tRate,\n\t\tSurname,\n\t\tValue,\n\t\tSourceFileName = PipelineSourceFileName,\n\t\tPayslipLineItemId,\n\t\tRecordModifiedDate,\n\t\tRecordCreatedDate,\n\t\tRecordIsDeleted,\n\t\tPipelineSourceFileName,\n\t\tProjectCode\n\t)) ~> SinkSqlDefinitivPayslips\nAggregate1 sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tumask: 0022,\n\tpreCommands: [],\n\tpostCommands: [],\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tsaveOrder: 1) ~> sink1"
		}
	}
}